<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <!-- reset -->
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      hr{
        margin: 10px 0;
      }
    </style>

    <!-- mytab -->
    <style>
      .mytab {
        margin: 0;
        padding: 0;
        color: white;
      }

      html,
      body {
        width: 100%;
        height: 100%;
      }

      ul,
      ol,
      li {
        list-style-type: none;
      }

      .mytab {
        width: 400px;
        height: 300px;
        border: 1px solid black;
        display: flex;
        flex-direction: column;
      }

      .mytab > ul {
        width: 100%;
        height: 60px;
        display: flex;
        border-bottom: 1px solid black;
      }

      .mytab > ul > li {
        flex-grow: 1;
        height: 100%;
        background-color: orange;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
      }

      .mytab > ul > li.active {
        background-color: darkorange;
      }

      .mytab > ol {
        width: 100%;
        flex-grow: 1;
        position: relative;
      }

      .mytab > ol > li {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        display: none;
        justify-content: center;
        align-items: center;
        font-size: 50px;
      }

      .mytab > ol > li.active {
        display: flex;
        background-color: skyblue;
      }

      .mytab button {
        height: 30px;
        margin: 5px;
      }
    </style>

    <!-- enclosure -->
    <style>
      .enclosure input {
        width: 300px;
      }
      .enclosure button {
        width: 100px;
        height: 30px;
        margin: 0;
        margin-top: 5px;
      }
    </style>

    <!-- animate -->
    <style>
      .animate {
        width: 400px;
        height: 500px;
        border: 1px solid black;
        position: relative;
      }
      .animate .abox {
        width: 100px;
        height: 100px;
        background-color: yellow;
        position: absolute;
      }
    </style>

    <!-- ajax -->
    <style>
      .ajax button {
        height: 30px;
        padding: 5px;
        margin: 0;
      }
    </style>
    
  </head>

  <body>
    <h3>使用闭包管理全班学生成绩</h3>
    <div class="enclosure">
      <input type="text" id="ipName" placeholder="姓名" /><br />
      <input type="text" id="ipSubject" placeholder="科目" /><br />
      <input type="text" id="ipScore" placeholder="成绩" /><br />
      <button id="btnSetScore">设置</button>
      <button id="btnGetScore">查询</button>
      <button id="btnPrint">成绩单</button>
      <p id="pRet">查询结果</p>
    </div>
    <hr />

    <h3>MyTab</h3>
    <div class="mytab_wrapper">
      <!-- 参考布局 做题时可以从这里拷贝 -->
      <!-- <div class="mytab">
        <ul>
          <li class="active">1</li>
          <li>2</li>
          <li>3</li>
        </ul>
        <ol>
          <li class="active">1</li>
          <li>2</li>
          <li>3</li>
        </ol>
        <button id="btnLoop">轮播/停止</button>
      </div> -->
    </div>
    <hr />

    <h3>手封动画框架</h3>
    <div class="animate">
      <div class="abox"></div>
    </div>
    <hr />

    <h3>AJAX封装</h3>
    <div class="ajax">
      <button id="btnGet">发送GET请求</button>
      <button id="btnForm">发送表单数据</button>
      <button id="btnJson">发送JSON数据</button>
      <p id="ajaxResult">这里是请求结果</p>
    </div>

    <!-- 总分：100分 -->
    <script>
      /* 请罗列5组请求头+响应头，并简述其含义 */
      function fn1() {
        console.log(1, "User-Agent", "客户端浏览器信息");
        console.log(1, "Server", "服务端信息");

        console.log(2, "Cookie", "客户端携带Cookie");
        console.log(2, "Set-Cookie", "服务端设置Cookie");

        console.log(3, "If-None-Match", "客户端携带上次数据的指纹,如果不匹配服务端的指纹，则重新获取数据和指纹");
        console.log(3, "E-Tag", "服务端返回的数据的指纹");

        console.log(4, "If-Modified-Since", "客户端携带上次数据的尾更时间，如果自从上次尾更以来还发生过更改，则重新获取数据和特征");
        console.log(4, "Last-Modified", "服务端返回的数据的最后更新时间");

        console.log(5, "Accept", "客户端想要的数据类型");
        console.log(5, "Content-Type", "服务端返回的数据类型");
      }
      fn1();

      /* 使用批处理函数实现如下功能 */
      function fn2() {
        const arr = [1, 2, 3, 4, 5, 6, 7, 8, 9];

        // 遍历数组

        // 将所有元素映射为对应的平方数，打印映射出的新数组

        // 过滤出3的倍数，打印过滤后的结果数组

        // 判断arr中是否所有元素都是3的倍数

        // 判断arr中是否有元素都是3的倍数

        // 从数组中找出第一个3的倍数

        // 求arr中所有元素的和，使用reduce实现
        let resultOfIterate = arr.reduce((previousValue, currentValue) => previousValue + currentValue)
        console.log(resultOfIterate);
        // 在100的基础上，加入arr中所有元素的和，使用reduce实现
        const initialValue = 100;
        resultOfIterate = arr.reduce((previousValue, currentValue, currentIndex, _arr) => previousValue + currentValue, initialValue)
        console.log(resultOfIterate);
      }
      fn2()

      /* 如果没有arr.map 你怎么办 */
      function fn3() {
        Array.prototype.mymap = function (fn) {
          const newArr = [];
          for (let i = 0; i < this.length; i++) {
            newArr[i] = fn(this[i], i, this)
          }
          return newArr
        }

        const arr = [1,2,3]
        const narr = arr.mymap(
          item=>item*item
        )

        // 输出结果应为[1,4,9]
        console.log(narr);
      }
      fn3()

      /* 冒泡排序数组 */
      function fn4() {
        function bubbleSort(arr){
          for (let i = 0; i < arr.length - 1; i++) {
            for (let j = 0; j < arr.length - 1 - i; j++) {
              if (arr[j] > arr[j + 1]) {
                [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]]
              }
            }
          }
        }

        const arr = [3,1,4,5,9,2,6,8,7,0]
        bubbleSort(arr)
        // 使结果为[0,1,2,3,4,5,6,7,8,9]
        console.log(arr);
      }
      fn4();

      /* 手撸深拷贝 */
      function fn5() {
        function deepCopy(obj) {
          if (obj === null || typeof(obj) !== 'object') {
            return obj
          } else {
            let result = Array.isArray(obj) ? [] : {};
            for (const key in obj) {
              result[key] = deepCopy(obj[key]);
            }
            return result;
          }
        }

        /* 不要改动测试代码 */
        function test() {
          // 待拷贝对象
          const obj1 = {
            name: "黑哥",
            age: 18,
            friends: [
              { name: "白鸽", age: 19 },
              {
                name: "宏哥",
                age: 20,
                say() {
                  console.log("hello");
                },
              },
            ],
          };

          /* 得到obj1的深拷贝副本 */
          const obj2 = deepCopy(obj1);

          /* 修改副本 */
          obj2.name = "black";
          obj2.friends[0].age = 29;
          obj2.friends[1].say = () => console.log("hi!");

          /* 观察本体是否受到影响 */
          console.log(obj1.name, obj2.name); //黑哥 black
          console.log(obj1.friends[0].age, obj2.friends[0].age); //19 29
          obj1.friends[1].say(); //hello
          obj2.friends[1].say(); //hi
        }
        test();
      }
      fn5();

      /* Promise链式回调 */
      function fn6() {
        /* 云端乘法函数，请不要修改其代码 */
        function multiply(a, b, callback) {
          setTimeout(() => callback(a * b), 2000);
        }

        function mulPromise(a, b) {
          return new Promise((resolve, reject) =>
            multiply.apply(null, [a, b, (ret) => resolve(ret)])
          );
        }

        // 基于multiply函数，使用Promise链式回调求得5的阶乘；
        mulPromise(1, 2)
        .then(ret => mulPromise(ret, 3))
        .then(ret => mulPromise(ret, 4))
        .then(ret => mulPromise(ret, 5))
        .then(ret => console.log('fn6()的输出在这里，兄弟', ret))
      }
      fn6();

      /* async-await */
      function fn7() {
        /* 云端乘法函数，请不要修改其代码 */
        function multiply(a, b, callback) {
          setTimeout(() => {
            // 注意这里有机会出错！！！！！
            Math.random() > 0.5 ? callback(a * b) : callback(-1);
          }, 500);
        }

        function mulPromise(a, b) {
          return new Promise((resolve, reject) => {
            multiply.apply(null, [
              a,
              b,
              (ret) => {
                ret === -1 ? reject("云端计算失败") : resolve(ret);
              },
            ]);
          });
        }

        // 基于multiply函数，使用async-await求得5的阶乘，如果云端出错妥善处理之
        async function afn() {
          let res;
          try {
            res = await mulPromise(1, 2);
            res = await mulPromise(res, 3);
            res = await mulPromise(res, 4);
            res = await mulPromise(res, 5);
          } catch (error) {
            console.log(error);
            console.log('重新发起计算...');
            afn()
            return
          }
          console.log('计算终于成功，人品不错，恭喜！！！');
          console.log('fn7()的输出在这里，兄弟', res);
        }
        afn()
      }
      fn7();

      /* 带有超时功能的Promise */
      function fn8() {
        async function execWithTimeout(fn, ms) {
          //实现之
          return Promise.race([fn1(), new Promise((resolve, reject) => {
            setTimeout(() => {
              reject('time out.')
            }, ms);
          })])
        }

        /* 测试代码 */
        async function fn1() {
          return rq("https://www.taobao.com");
        }

        function rq(url) {
          return new Promise((resolve) =>
            setTimeout(() => resolve(`${url}的页面`), 200)
          );
        }

        execWithTimeout(fn1, 300)
          .then((data) => console.log("data=", data))
          .catch((err) => console.log("err=", err));
      }
      fn8()

      /* 一次性获取多个指定页面 */
      function fn9() {
        async function getContentByUrl(url) {
          return new Promise((resolve, reject) => {
            setTimeout(() => {
              resolve(`${url}的页面内容`);
            }, 1000);
          });
        }

        async function fetchData(urls) {
          const filteredUrls = urls.filter(url => url.startsWith('https://www.'));
          const resultArr = [];
          for (const url of filteredUrls) {
            resultArr.push(await getContentByUrl(url))
          }
          console.log('fn9()的输出在这里，兄弟');
          return resultArr
        }

        const urls = [
          "https://www.taobao.com",
          "https://www.baidu.com",
          "https://web.taobao.com",
        ];

        // ["https://www.taobao.com的页面内容","https://www.baidu.com 的页面内容"]
        fetchData(urls).then((result) => console.log(result));
      }
      fn9();

      /* 手封数据结构MyMap */
      function fn10() {
        class MyMap {
          //实现之
        }

        /* 测试脚本 不要修改 */
        ~(function () {
          const mmap = new MyMap();

          /* 增加Key-value */
          mmap.set("a", "foo");
          mmap.set("b", "bar");
          mmap.set("c", "baz");
          mmap.set("d", "boo");

          /* 根据Key查询value */
          console.log(mmap.get("a"));
          console.log(mmap.get("b"));

          // 查询尺寸
          console.log(mmap.size);

          // 获取全部keys
          console.log(mmap.keys());

          // 获取全部values
          console.log(mmap.values());

          // 获取全部entries
          console.log(mmap.entries());

          /* 遍历mmap中的全部entry */
          for (let entry of mmap.entries()) {
            console.log(entry);
          }

          // 查询key是否存在
          console.log("has a?", mmap.has("a"));
          console.log("has toString?", mmap.has("toString"));
          console.log("has c?", mmap.has("c"));

          // 删除Key-value
          mmap.delete("b");
          console.log(mmap);

          // 修改
          mmap.set("a", "张真人");
          console.log(mmap.get("a"));

          /* for-Each */
          mmap.forEach((value, key) => {
            console.log(`{key:${key},value:${value}}`);
          });

          mmap.set("tesla", { boss: "mask", age: 48 });
          mmap.set("microsoft", { name: "bill", age: 80 });
          mmap.set("meta", { name: "zuckberg", age: 38 });
          mmap.set("alibaba", { name: "jack", age: 55 });

          /* 过滤掉年龄大于50的家伙 */
          const newMap = mmap.filter((value, key) => value.age < 50);
          console.log(newMap);
        })();
      }
      // fn10();

      /* 手封ajax + ajaxPromise */
      function fn11() {
        function ajax(conf) {
          //实现之
          const defaultConf = {
            method: 'GET',
            onSuccess() {reponseText => console.log(reponseText)},
            onFail() {err => console.log(err)},

            ...conf
          };

          let {method, url, data, dataType, onSuccess, onFail} = defaultConf;

          if (!url) {
            throw new Error('没传url，玩der！')
          }

          let requestBody = null;
          
          const xhr = new XMLHttpRequest();

          xhr.onload = () => {
            onSuccess(xhr.responseText)
          }

          xhr.onerror = (err) => {
            onFail(err) 
          }
          
          if (method.toUpperCase() === 'GET' && data) {
            url += `?${getSearchParams(data)}`;
          }

          xhr.open(method, url)

          switch (true) {
            case dataType === 'form':
              xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
              requestBody = getSearchParams(data);
              break;
            case dataType === 'json':
              xhr.setRequestHeader('Content-Type', 'application/json');
              requestBody = JSON.stringify(data);
              break;
          
            default:
              break;
          }

          xhr.send(requestBody)

          function getSearchParams(data) {
            let searchParams = '';
            for (const key in data) {
              searchParams += `${key}=${data[key]}&` 
            }
            searchParams = searchParams.slice(0, -1);
            return searchParams
          }
        }

        function ajaxPromise(conf) {
          //实现之
          return new Promise((resolve, reject) => {
            ajax({
              ...conf,

              onSuccess(responseText) {
                conf.onSuccess && conf.onSuccess();
                resolve(responseText);
              },
              onFail(err) {
                conf.onFail && conf.onFail();
                reject(err);
              }
            })
          })
        }

        /* 测试代码 */
        btnGet.onclick = (e) => {
          ajaxPromise({
            url: "http://www.httpbin.org/get",
            data: { username: "admin", password: "123456" },
          })
            .then((res) => (ajaxResult.innerText = res))
            .catch((err) => (ajaxResult.innerText = err));
        };

        btnForm.onclick = (e) => {
          ajaxPromise({
            url: "http://www.httpbin.org/post",
            method:"POST",
            data: { username: "admin", password: "123456" },
            dataType:"form"
          })
            .then((res) => (ajaxResult.innerText = res))
            .catch((err) => (ajaxResult.innerText = err));
        };

        btnJson.onclick = (e) => {
          ajaxPromise({
            url: "http://www.httpbin.org/post",
            method:"POST",
            data: { username: "admin", password: "123456" },
            dataType:"json"
          })
            .then((res) => (ajaxResult.innerText = res))
            .catch((err) => (ajaxResult.innerText = err));
        };
      }
      fn11()

      /* 手封动画框架 */
      function fn12() {
        function animate(element, target, duration = 1000, onFinish) {
          //实现之
        }

        /* 测试代码 */
        const box = document.querySelector(".animate .abox")
        box.onclick = function () {
          animate(
            this,
            { left: "300px", top: "400px", opacity: 0.5 },
            3000,
            () => {
              console.log("动画结束");
            }
          );
        };
      }
      // fn12();

      /* 手封能自动轮播和停止的Tab切换 */
      function fn13() {
        class TabBox {}
      }
      // fn13();

      /* 使用闭包函数 实现对全班学生成绩的设置、查询、成绩打印 （参见页面DOM结构） */
      function fn14() {
        const students = ["张三", "李四", "王五"];

        function closure(name) {
          const scoreObj = {}
          return {
            setScore(subject, score) {
              scoreObj[subject] = score
            },
            getScore(subject) {
              return scoreObj[subject]
            },
            printScore() {
              return JSON.stringify(scoreObj)
            }
          }
        }

        const obj = {};
        // students.forEach(student => {
        //   obj[student] = closure(student)
        // });
        // console.log(obj);

        btnSetScore.onclick = () => {
          if (!obj[ipName.value]) {
            obj[ipName.value] = closure(ipName.value)
          }
          obj[ipName.value].setScore(ipSubject.value, ipScore.value*1)
          console.log('设置成功');
        }

        btnGetScore.onclick = () => {
          try {
            pRet.innerText = obj[ipName.value].getScore(ipSubject.value);
          } catch {
            pRet.innerText = '你查个der~~~';
          }
        }

        btnPrint.onclick = () => {
          pRet.innerText = obj[ipName.value].printScore()
        }
      }
      fn14()
    </script>

  </body>
</html>
